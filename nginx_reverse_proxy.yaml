hosts: localhost
tasks:
  - name: unlink nginx default cfg
    file:
      path: /etc/sites-enabled/default
      state: absent
    notify:
      - reload nginx

  - name: create new nginx cfg
    copy:
      content: |
        server {
          listen 80;
          server_name {{ https_domain_url }};
          location / {
            proxy_pass         http://localhost:{{ port }};
            proxy_http_version 1.1;
            proxy_set_header   Upgrade $http_upgrade;
            proxy_set_header   Connection "upgrade";
            proxy_set_header   Host $host;
          }
        }
      dest: "/etc/nginx/sites-available/{{ https_domain_url }}.conf"

    file:
      path: /etc/sites-enabled/default

  - name: Restart Nginx service
    service:
      name: nginx
      state: restarted

  - name: Ensure certbot service is enabled
    service:
      name: certbot.timer
      state: started

  - name: Running certbot certificate renewal
    shell: certbot -d {{ https_domain_url }} --nginx
